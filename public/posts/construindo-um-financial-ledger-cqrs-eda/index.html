<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description"
    content="Thoughts, ideas, and projects from Lerian Studio">
<meta name="author" content="Lerian Studio">

<meta property="og:title" content="construindo um financial ledger com cqrs e eda | Lerian Studio Blog">
<meta property="og:description"
    content="Thoughts, ideas, and projects from Lerian Studio">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.lerian.studio/posts/construindo-um-financial-ledger-cqrs-eda/">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="construindo um financial ledger com cqrs e eda | Lerian Studio Blog">
<meta name="twitter:description"
    content="Thoughts, ideas, and projects from Lerian Studio">

<link rel="icon" type="image/png" href="https://blog.lerian.studio/%20/favicon.png">
<link rel="canonical" href="https://blog.lerian.studio/posts/construindo-um-financial-ledger-cqrs-eda/">
    
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Serif:wght@400;500;600;700&display=swap" rel="stylesheet">


<link rel="stylesheet" href="https://blog.lerian.studio/css/main.css">


    <title>construindo um financial ledger com cqrs e eda | Lerian Studio Blog</title>
</head>

<body>
    <header class="header">
    <div class="header__container">
        <div class="header__logo">
            <a href="https://blog.lerian.studio/%20/" class="logo">Lerian Studio Blog</a>
        </div>

        <nav class="header__nav">
            <ul class="nav__menu">
                <li><a href="https://blog.lerian.studio/%20/" class="nav__link">Home</a></li>
                <li><a href="https://blog.lerian.studio/%20/posts/" class="nav__link">Articles</a></li>
                <li><a href="https://blog.lerian.studio/%20/categories/" class="nav__link">Categories</a></li>
                <li><a href="https://blog.lerian.studio/%20/tags/" class="nav__link">Tags</a></li>
                <li><a href="https://blog.lerian.studio/%20/about/" class="nav__link">About</a></li>
            </ul>

            <button class="nav__toggle" id="nav-toggle">
                <span class="nav__hamburger"></span>
                <span class="nav__hamburger"></span>
                <span class="nav__hamburger"></span>
            </button>
        </nav>
    </div>
</header>

    <main class="main">
        
<div class="container">
    <article class="post">
        <header class="post__header">
            <h1 class="post__title">construindo um financial ledger com cqrs e eda</h1>

            <div class="post__meta">
                <time datetime=" 2025-05-15" class="post__date">
                    May 15, 2025
                </time>

                

                
                <span class="post__separator">‚Ä¢</span>
                <span class="post__reading-time">11 min read</span>
                

                <span class="post__separator">‚Ä¢</span>
                <span class="post__word-count">2167 words</span>
            </div>

            
            <div class="post__tags">
                
                <a href="https://blog.lerian.studio/%20/tags/fintech/" class="tag">fintech</a>
                
                <a href="https://blog.lerian.studio/%20/tags/architecture/" class="tag">architecture</a>
                
                <a href="https://blog.lerian.studio/%20/tags/cqrs/" class="tag">cqrs</a>
                
                <a href="https://blog.lerian.studio/%20/tags/eda/" class="tag">eda</a>
                
                <a href="https://blog.lerian.studio/%20/tags/ledger/" class="tag">ledger</a>
                
            </div>
            

            
            <div class="post__categories">
                <span class="post__categories-label">Categories:</span>
                
                <a href="https://blog.lerian.studio/%20/categories/architecture/" class="category-link">Architecture</a>
                
                <a href="https://blog.lerian.studio/%20/categories/financial-technology/" class="category-link">Financial Technology</a>
                
            </div>
            
        </header>

        
        <div class="post__featured-image">
            <img src="https://blog.lerian.studio/images/posts/financial-ledger-hero.jpg" alt="Financial technology and data visualization representing CQRS and EDA architecture"
                class="post__image">
            
            <figcaption class="post__image-caption">Modern financial systems require sophisticated architectures to handle complex transactions and maintain data integrity</figcaption>
            
        </div>
        

        <div class="post__content">
            <p>no mundo da tecnologia financeira, construir sistemas robustos, escal√°veis e confi√°veis √© fundamental. os ledgers financeiros, em particular, requerem considera√ß√µes de arquitetura para garantir que possam lidar com transa√ß√µes complexas, mantendo a integridade dos dados e o desempenho. neste artigo, exploraremos como o command query responsibility segregation (cqrs) e a event-driven architecture (eda) podem ser combinados para criar sistemas financeiros poderosos, usando nosso ledger financeiro de c√≥digo aberto, midaz, como estudo de caso.</p>
<p>nota: deixarei os diagramas em &lsquo;mermaid&rsquo; caso queiram visualizar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>graph TD
</span></span><span style="display:flex;"><span>    subgraph &#34;cqrs + eda architecture&#34;
</span></span><span style="display:flex;"><span>        subgraph &#34;client layer&#34;
</span></span><span style="display:flex;"><span>            UI[ui/api clients]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;api layer&#34;
</span></span><span style="display:flex;"><span>            API[api gateway]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;command layer&#34;
</span></span><span style="display:flex;"><span>            CMD[command handlers]
</span></span><span style="display:flex;"><span>            VAL[validators]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;event bus&#34;
</span></span><span style="display:flex;"><span>            EB[rabbitmq]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;domain layer&#34;
</span></span><span style="display:flex;"><span>            DOM[domain logic]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;persistence&#34;
</span></span><span style="display:flex;"><span>            WRTDB[(write database)]
</span></span><span style="display:flex;"><span>            RDDB[(read database)]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        subgraph &#34;query layer&#34;
</span></span><span style="display:flex;"><span>            QRY[query handlers]
</span></span><span style="display:flex;"><span>            VM[view models]
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        UI --&gt; API
</span></span><span style="display:flex;"><span>        API --&gt; CMD
</span></span><span style="display:flex;"><span>        API --&gt; QRY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CMD --&gt; VAL
</span></span><span style="display:flex;"><span>        CMD --&gt; DOM
</span></span><span style="display:flex;"><span>        DOM --&gt; WRTDB
</span></span><span style="display:flex;"><span>        DOM --&gt; EB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        EB --&gt; VM
</span></span><span style="display:flex;"><span>        VM --&gt; RDDB
</span></span><span style="display:flex;"><span>        QRY --&gt; RDDB
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    classDef client fill:#9FA8DA,color:black;
</span></span><span style="display:flex;"><span>    classDef api fill:#7986CB,color:white;
</span></span><span style="display:flex;"><span>    classDef command fill:#5C6BC0,color:white;
</span></span><span style="display:flex;"><span>    classDef domain fill:#3F51B5,color:white;
</span></span><span style="display:flex;"><span>    classDef eventbus fill:#8BC34A,color:black;
</span></span><span style="display:flex;"><span>    classDef storage fill:#FFB74D,color:black;
</span></span><span style="display:flex;"><span>    classDef query fill:#FF8A65,color:black;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    class UI client;
</span></span><span style="display:flex;"><span>    class API api;
</span></span><span style="display:flex;"><span>    class CMD,VAL command;
</span></span><span style="display:flex;"><span>    class DOM domain;
</span></span><span style="display:flex;"><span>    class EB eventbus;
</span></span><span style="display:flex;"><span>    class WRTDB,RDDB storage;
</span></span><span style="display:flex;"><span>    class QRY,VM query;
</span></span></code></pre></div><h2 id="o-desafio-dos-sistemas-financeiros">o desafio dos sistemas financeiros</h2>
<p>sistemas financeiros apresentam desafios √∫nicos que arquiteturas monol√≠ticas tradicionais t√™m dificuldade em resolver:</p>
<ul>
<li>alto volume de transa√ß√µes: sistemas financeiros devem processar milhares, sen√£o milh√µes/bilh√µes, de transa√ß√µes diariamente</li>
<li>regras de neg√≥cio complexas: transa√ß√µes financeiras envolvem regras complexas, valida√ß√µes e c√°lculos</li>
<li>consist√™ncia de dados: os dados financeiros devem permanecer consistentes em m√∫ltiplas opera√ß√µes</li>
<li>requisitos de auditoria: cada opera√ß√£o financeira deve ser rastre√°vel e audit√°vel</li>
<li>preocupa√ß√µes com escalabilidade: o sistema deve escalar para lidar com volumes crescentes de transa√ß√µes, de maneira a n√£o comprometer a sua integridade, ao mesmo tempo mantendo a quest√£o de custo em voga</li>
</ul>
<p>esses desafios exigem padr√µes de design de software que possam separar responsabilidades, escalar independentemente e manter a integridade dos dados. √© aqui que o cqrs e a arquitetura orientada a eventos entram em cena.</p>
<h2 id="entendendo-o-cqrs-em-sistemas-financeiros">entendendo o cqrs em sistemas financeiros</h2>
<p>command query responsibility segregation (cqrs) √© um padr√£o de design que separa opera√ß√µes de leitura e escrita em modelos distintos. em um contexto financeiro, essa separa√ß√£o √© particularmente valiosa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sequenceDiagram
</span></span><span style="display:flex;"><span>    participant Client
</span></span><span style="display:flex;"><span>    participant API as api gateway
</span></span><span style="display:flex;"><span>    participant CH as command handler
</span></span><span style="display:flex;"><span>    participant DB as write database
</span></span><span style="display:flex;"><span>    participant EB as event bus
</span></span><span style="display:flex;"><span>    participant QH as query handler
</span></span><span style="display:flex;"><span>    participant RDB as read database
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Client-&gt;&gt;API: POST /transactions
</span></span><span style="display:flex;"><span>    API-&gt;&gt;CH: CreateTransactionCommand
</span></span><span style="display:flex;"><span>    CH-&gt;&gt;DB: Save Transaction
</span></span><span style="display:flex;"><span>    CH-&gt;&gt;EB: Publish TransactionCreatedEvent
</span></span><span style="display:flex;"><span>    EB--&gt;&gt;RDB: Update Read Model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Client-&gt;&gt;API: GET /transactions/{id}
</span></span><span style="display:flex;"><span>    API-&gt;&gt;QH: GetTransactionQuery
</span></span><span style="display:flex;"><span>    QH-&gt;&gt;RDB: Fetch Transaction DTO
</span></span><span style="display:flex;"><span>    QH--&gt;&gt;API: Transaction Details
</span></span><span style="display:flex;"><span>    API--&gt;&gt;Client: Transaction Response
</span></span></code></pre></div><h2 id="o-lado-do-command-write-model">o lado do command (write model)</h2>
<p>o lado do command lida com opera√ß√µes que mudam o estado do sistema, como:</p>
<ul>
<li>criar novas contas</li>
<li>registrar transa√ß√µes financeiras</li>
<li>atualizar saldos</li>
<li>modificar informa√ß√µes de ativos</li>
</ul>
<p>no midaz, nossos servi√ßos de command s√£o estruturados com responsabilidades claras e focadas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// de components/onboarding/internal/services/command/command.go</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UseCase</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">OrganizationRepo</span> <span style="color:#a6e22e">organization</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LedgerRepo</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SegmentRepo</span> <span style="color:#a6e22e">segment</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PortfolioRepo</span> <span style="color:#a6e22e">portfolio</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AccountRepo</span> <span style="color:#a6e22e">account</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AssetRepo</span> <span style="color:#a6e22e">asset</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MetadataRepo</span> <span style="color:#a6e22e">mongodb</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RabbitMQRepo</span> <span style="color:#a6e22e">rabbitmq</span>.<span style="color:#a6e22e">ProducerRepository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RedisRepo</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">RedisRepository</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>cada opera√ß√£o de command √© isolada em seu pr√≥prio arquivo com uma √∫nica responsabilidade - nota: algo que inclusive facilita, e muito, a leitura e manuten√ß√£o do c√≥digo. por exemplo, criando uma nova conta em create-account.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// simplificado de create-account.go</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">uc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UseCase</span>) <span style="color:#a6e22e">CreateAccount</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">account</span>.<span style="color:#a6e22e">Account</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">account</span>.<span style="color:#a6e22e">Account</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// validar entrada</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// gerar ID √∫nico</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// armazenar no reposit√≥rio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// publicar evento</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// retornar resultado</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="o-lado-do-query-read-model">o lado do query (read model)</h2>
<p>o lado do query se concentra em recuperar e apresentar dados:</p>
<ul>
<li>buscar informa√ß√µes de contas</li>
<li>recuperar hist√≥rico de transa√ß√µes</li>
<li>gerar relat√≥rios</li>
<li>ler saldos</li>
</ul>
<p>no midaz, os servi√ßos de query s√£o estruturados de forma semelhante, mas otimizados para leitura:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// de components/onboarding/internal/services/query/query.go</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UseCase</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">OrganizationRepo</span> <span style="color:#a6e22e">organization</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LedgerRepo</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SegmentRepo</span> <span style="color:#a6e22e">segment</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PortfolioRepo</span> <span style="color:#a6e22e">portfolio</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AccountRepo</span> <span style="color:#a6e22e">account</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AssetRepo</span> <span style="color:#a6e22e">asset</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MetadataRepo</span> <span style="color:#a6e22e">mongodb</span>.<span style="color:#a6e22e">Repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RedisRepo</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">RedisRepository</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>as opera√ß√µes de query tamb√©m s√£o isoladas em arquivos dedicados, como buscar detalhes de uma conta em get-id-account.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// simplificado de get-id-account.go</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">uc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UseCase</span>) <span style="color:#a6e22e">GetIDAccount</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#a6e22e">uuid</span>.<span style="color:#a6e22e">UUID</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">account</span>.<span style="color:#a6e22e">Account</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// buscar do reposit√≥rio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// transformar se necess√°rio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// retornar dados</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="benef√≠cios-do-cqrs-em-sistemas-financeiros">benef√≠cios do cqrs em sistemas financeiros</h2>
<ul>
<li>
<p>performance optimization: write models e read models podem ser otimizados independentemente. para sistemas financeiros com muito mais leituras do que escritas (usu√°rios verificando saldos versus fazendo transa√ß√µes), isso √© crucial. nossa implementa√ß√£o de queries demonstra essa otimiza√ß√£o</p>
</li>
<li>
<p>scalability: commands e queries podem escalar separadamente. durante per√≠odos de alto volume (como processos financeiros de final de m√™s ou fim de ano), os servi√ßos de query podem ser escalados sem afetar o processamento de transa√ß√µes. isso √© facilitado por nossa infraestrutura de cont√™ineres</p>
</li>
<li>
<p>specialized data storage: commands podem usar armazenamento otimizado para opera√ß√µes de escrita (como postgresql), enquanto queries podem usar armazenamento otimizado para leitura (como mongodb para consulta flex√≠vel de metadados)</p>
</li>
<li>
<p>reduced complexity: ao separar concerns, a domain logic complexa em opera√ß√µes financeiras torna-se mais gerenci√°vel, reduzindo bugs e melhorando a manutenibilidade, como pode ser visto em nosso transaction domain</p>
</li>
</ul>
<h2 id="event-driven-architecture-em-sistemas-financeiros">event-driven architecture em sistemas financeiros</h2>
<p>enquanto o cqrs aborda muitos desafios, sistemas financeiros tamb√©m se beneficiam de loose coupling e processamento ass√≠ncrono. √© aqui que a event-driven architecture (eda) se destaca.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>graph TD
</span></span><span style="display:flex;"><span>    subgraph &#34;financial transaction&#34;
</span></span><span style="display:flex;"><span>        TX[transaction creation] --&gt;|publishes| E1[TransactionCreatedEvent]
</span></span><span style="display:flex;"><span>        E1 --&gt;|consumed by| P1[balance processor]
</span></span><span style="display:flex;"><span>        E1 --&gt;|consumed by| P2[notification processor]
</span></span><span style="display:flex;"><span>        E1 --&gt;|consumed by| P3[audit service]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        P1 --&gt;|publishes| E2[BalanceUpdatedEvent]
</span></span><span style="display:flex;"><span>        E2 --&gt;|consumed by| P4[reporting service]
</span></span><span style="display:flex;"><span>        E2 --&gt;|consumed by| P5[customer notification]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        P3 --&gt;|publishes| E3[AuditRecordEvent]
</span></span><span style="display:flex;"><span>        E3 --&gt;|consumed by| P6[regulatory compliance]
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    classDef command fill:#4CAF50,color:white;
</span></span><span style="display:flex;"><span>    classDef event fill:#FF9800,color:white;
</span></span><span style="display:flex;"><span>    classDef processor fill:#2196F3,color:white;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    class TX command;
</span></span><span style="display:flex;"><span>    class E1,E2,E3 event;
</span></span><span style="display:flex;"><span>    class P1,P2,P3,P4,P5,P6 processor;
</span></span></code></pre></div><h2 id="conceitos-principais-de-eda-no-contexto-financeiro">conceitos principais de eda no contexto financeiro</h2>
<ul>
<li>events as facts: cada evento financeiro (transa√ß√£o criada, saldo atualizado, etc.) √© registrado como um fato imut√°vel</li>
<li>asynchronous processing: opera√ß√µes que n√£o exigem respostas imediatas podem ser processadas de forma ass√≠ncrona, melhorando o desempenho e a experi√™ncia do usu√°rio</li>
<li>decoupled services: servi√ßos se comunicam atrav√©s de eventos, reduzindo depend√™ncias diretas</li>
</ul>
<h2 id="o-transaction-flow">o transaction flow</h2>
<ul>
<li>command initiation: um command √© recebido para criar uma transa√ß√£o (por exemplo, transferir fundos entre contas)</li>
<li>validation and processing: o command handler valida a transa√ß√£o, cria os registros necess√°rios e publica um evento</li>
<li>asynchronous effects: event handlers processam os efeitos da transa√ß√£o de forma ass√≠ncrona:
<ul>
<li>atualizando saldos de contas</li>
<li>criando registros de opera√ß√£o</li>
<li>gerando logs de auditoria</li>
</ul>
</li>
<li>read model updates: uma vez que os efeitos est√£o completos, os read models s√£o atualizados, tornando as mudan√ßas vis√≠veis para queries</li>
</ul>
<h2 id="a-technical-architecture">a technical architecture</h2>
<p>nossos servi√ßos s√£o estruturados para suportar este fluxo:</p>
<ul>
<li>api layer: endpoints http recebem commands e queries, documentados em nossa api swagger</li>
<li>command/query services: servi√ßos separados lidam com as respectivas opera√ß√µes em components/transaction/internal/services</li>
<li>event bus: rabbitmq fornece reliable message delivery entre servi√ßos</li>
<li>storage layer:
<ul>
<li>postgresql para dados transacionais estruturados</li>
<li>mongodb para armazenamento flex√≠vel de metadados</li>
<li>redis para dados ef√™meros como idempotency keys</li>
</ul>
</li>
</ul>
<h2 id="distributed-transactions">distributed transactions</h2>
<p>um dos desafios em sistemas financeiros √© manter a consist√™ncia entre opera√ß√µes distribu√≠das. no midaz, lidamos com isso atrav√©s de:</p>
<ul>
<li>eventual consistency: a maioria das opera√ß√µes n√£o requer consist√™ncia imediata, permitindo-nos usar processamento ass√≠ncrono via rabbitmq</li>
<li>optimistic concurrency: quando conflitos podem ocorrer, usamos version tracking para detect√°-los e trat√°-los, como implementado em nossos data models</li>
<li>compensating actions: para falhas em processos de m√∫ltiplas etapas, implementamos compensating actions para manter a consist√™ncia geral atrav√©s dos event consumers</li>
</ul>
<h2 id="benef√≠cios-no-mundo-real-e-li√ß√µes-aprendidas">benef√≠cios no mundo real e li√ß√µes aprendidas</h2>
<p>a implementa√ß√£o de cqrs e eda no midaz trouxe v√°rios benef√≠cios significativos que t√™m impactado diretamente a qualidade, manutenibilidade e efici√™ncia do nosso sistema financeiro.</p>
<h3 id="benef√≠cios-tang√≠veis">benef√≠cios tang√≠veis</h3>
<p>melhor desempenho: ao separar preocupa√ß√µes de leitura e escrita, otimizamos cada caminho para seus requisitos espec√≠ficos. nossos servi√ßos de query s√£o especializados para recuperar dados com alta efici√™ncia, enquanto os servi√ßos de command s√£o projetados para garantir a integridade dos dados durante as opera√ß√µes de escrita. na pr√°tica, isso nos permitiu:</p>
<ul>
<li>reduzir o tempo de resposta para consultas frequentes em at√© 60%</li>
<li>aumentar o throughput de transa√ß√µes em per√≠odos de pico</li>
<li>eliminar conten√ß√µes de recursos entre opera√ß√µes de leitura e escrita</li>
</ul>
<p>melhor escalabilidade: servi√ßos podem escalar independentemente com base em seus padr√µes de carga. isso foi particularmente valioso durante:</p>
<ul>
<li>per√≠odos de fechamento financeiro mensal, quando a frequ√™ncia de consultas aumenta significativamente</li>
<li>processamentos em lote de transa√ß√µes, que podem ser escalados horizontalmente sem afetar os servi√ßos de consulta</li>
<li>expans√£o para novos mercados, permitindo-nos aumentar seletivamente a capacidade de servi√ßos espec√≠ficos</li>
</ul>
<p>nossa configura√ß√£o de infraestrutura facilita essa escalabilidade independente.</p>
<p>confiabilidade aprimorada: processamento ass√≠ncrono e opera√ß√µes idempotentes reduzem o impacto de falhas tempor√°rias. nosso mecanismo de idempot√™ncia garante que transa√ß√µes n√£o sejam duplicadas, mesmo em caso de retentativas, enquanto nosso sistema de mensageria ass√≠ncrona permite:</p>
<ul>
<li>recupera√ß√£o graceful ap√≥s falhas em componentes</li>
<li>resili√™ncia contra indisponibilidade tempor√°ria de servi√ßos</li>
<li>processamento consistente mesmo durante picos de carga</li>
</ul>
<p>evolu√ß√£o mais f√°cil: servi√ßos desacoplados nos permitem evoluir diferentes partes do sistema independentemente. nossa experi√™ncia pr√°tica demonstrou que:</p>
<ul>
<li>novas funcionalidades podem ser adicionadas aos servi√ßos de transaction sem afetar os servi√ßos de onboarding</li>
<li>atualiza√ß√µes de esquema em um modelo (leitura ou escrita) podem ser realizadas sem impactar o outro</li>
<li>novas vers√µes de apis podem ser lan√ßadas gradualmente, mantendo compatibilidade com vers√µes anteriores</li>
</ul>
<p>auditabilidade aprimorada: um benef√≠cio n√£o antecipado inicialmente foi a excelente rastreabilidade proporcionada por nossa arquitetura orientada a eventos. cada mudan√ßa de estado √© registrada como um evento, facilitando:</p>
<ul>
<li>reconstru√ß√£o do hist√≥rico completo de transa√ß√µes</li>
<li>atendimento a requisitos regulat√≥rios de auditoria financeira</li>
<li>an√°lise de causa-raiz em cen√°rios de inconsist√™ncia de dados</li>
</ul>
<p>nossa implementa√ß√£o de logs de transa√ß√µes demonstra esse compromisso com a auditabilidade.</p>
<h3 id="li√ß√µes-valiosas-aprendidas">li√ß√µes valiosas aprendidas</h3>
<p>trade-off de complexidade: cqrs e eda adicionam complexidade que deve ser justificada pelos benef√≠cios. aprendemos que:</p>
<ul>
<li>a separa√ß√£o de modelos n√£o √© necess√°ria para todas as entidades do dom√≠nio. entidades com baixa taxa de mudan√ßa e consulta simples podem usar um modelo unificado</li>
<li>a complexidade adicional exige investimento em documenta√ß√£o clara e treinamento da equipe. nosso CONTRIBUTING.md e STRUCTURE.md foram criados para facilitar esse processo</li>
<li>ferramentas de observabilidade s√£o essenciais para entender o fluxo de dados em um sistema distribu√≠do. investimos em integra√ß√£o com grafana para monitoramento</li>
</ul>
<p>desafios de consist√™ncia eventual: as equipes precisam projetar uis e experi√™ncias que levem em conta a consist√™ncia eventual. isso incluiu:</p>
<ul>
<li>desenvolver padr√µes de ux para comunicar estados tempor√°rios aos usu√°rios</li>
<li>implementar mecanismos de polling e notifica√ß√£o para atualizar a interface quando dados s√£o modificados</li>
<li>educar stakeholders sobre os trade-offs entre consist√™ncia forte e disponibilidade</li>
<li>criar mecanismos de sincroniza√ß√£o para casos cr√≠ticos onde a consist√™ncia imediata √© necess√°ria</li>
</ul>
<p>import√¢ncia do monitoramento: sistemas distribu√≠dos orientados a eventos requerem monitoramento e rastreamento abrangentes. para isso:</p>
<ul>
<li>implementamos rastreamento distribu√≠do em todo o sistema usando opentelemetry, como visto em nossos servi√ßos de command</li>
<li>criamos dashboards especializados para visualizar fluxos de eventos e filas</li>
<li>estabelecemos alertas para detectar anomalias em padr√µes de consumo de eventos</li>
<li>introduzimos correla√ß√£o de ids entre servi√ßos para facilitar o rastreamento de transa√ß√µes completas</li>
</ul>
<p>estrat√©gias de teste: testar sistemas orientados a eventos requer abordagens diferentes das aplica√ß√µes monol√≠ticas tradicionais. nosso aprendizado incluiu:</p>
<ul>
<li>desenvolver testes de integra√ß√£o que simulam o fluxo completo de eventos</li>
<li>criar mocks de produtores e consumidores para testar componentes isoladamente</li>
<li>implementar testes que verificam a idempot√™ncia e a resili√™ncia a falhas</li>
<li>utilizar golden files para validar a consist√™ncia dos resultados</li>
</ul>
<p>equilibrando inova√ß√£o t√©cnica e valor de neg√≥cio: uma li√ß√£o fundamental foi a import√¢ncia de alinhar decis√µes de design com necessidades reais de neg√≥cio:</p>
<ul>
<li>nem todas as partes do sistema precisam da mesma sofistica√ß√£o t√©cnica</li>
<li>iniciar com componentes cr√≠ticos para o neg√≥cio e evoluir incrementalmente</li>
<li>medir o impacto real das otimiza√ß√µes em m√©tricas de neg√≥cio, como tempo de processamento de transa√ß√µes e disponibilidade do sistema</li>
<li>envolver stakeholders n√£o-t√©cnicos na compreens√£o dos trade-offs da arquitetura adotada</li>
</ul>
<h2 id="casos-de-uso-reais">casos de uso reais</h2>
<p>para ilustrar o impacto pr√°tico dessas escolhas de design, destacamos alguns casos de uso reais onde cqrs e eda provaram seu valor:</p>
<ul>
<li>processamento de transa√ß√µes de alta frequ√™ncia: o sistema consegue processar milh√µes de transa√ß√µes por minuto, com cada transa√ß√£o seguindo o fluxo de valida√ß√£o, processamento ass√≠ncrono e atualiza√ß√£o consistente de saldos</li>
<li>gera√ß√£o de relat√≥rios em tempo real: mesmo durante per√≠odos de alto volume transacional, os usu√°rios conseguem gerar relat√≥rios complexos sem impactar o desempenho do sistema de processamento</li>
<li>recupera√ß√£o de falhas: durante eventos de indisponibilidade de componentes, o sistema consegue retomar o processamento sem perda de dados, gra√ßas aos mecanismos de persist√™ncia de eventos e idempot√™ncia implementados no consumer rabbitmq</li>
</ul>
<h2 id="conclus√£o">conclus√£o</h2>
<p>cqrs e arquitetura orientada a eventos fornecem padr√µes poderosos para construir sistemas financeiros robustos. ao separar preocupa√ß√µes de leitura e escrita e aproveitar o processamento ass√≠ncrono, esses padr√µes permitem ledgers financeiros escal√°veis, confi√°veis e de f√°cil manuten√ß√£o.</p>
<p>no midaz, vimos como esses padr√µes podem ser aplicados para criar uma plataforma financeira flex√≠vel que lida com transa√ß√µes complexas, mantendo o desempenho e a integridade dos dados. a combina√ß√£o de cqrs e eda provou ser especialmente valiosa para problemas do dom√≠nio financeiro, onde consist√™ncia de dados, requisitos de auditoria e regras de neg√≥cio complexas convergem.</p>
<p>√† medida que a tecnologia financeira continua a evoluir, padr√µes de design como esses se tornar√£o ferramentas cada vez mais importantes na caixa de ferramentas do desenvolvedor para construir a pr√≥xima gera√ß√£o de sistemas financeiros.</p>

        </div>

        
        <div class="post__sharing">
            <h3 class="post__sharing-title">Share this article</h3>
            <div class="social-share">
                <a href="https://twitter.com/intent/tweet?text=construindo&#43;um&#43;financial&#43;ledger&#43;com&#43;cqrs&#43;e&#43;eda&url=https%3a%2f%2fblog.lerian.studio%2fposts%2fconstruindo-um-financial-ledger-cqrs-eda%2f"
                    target="_blank" rel="noopener" class="social-share__link social-share__twitter">
                    <span class="social-share__icon">ùïè</span>
                    <span class="social-share__text">Twitter</span>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fblog.lerian.studio%2fposts%2fconstruindo-um-financial-ledger-cqrs-eda%2f" target="_blank"
                    rel="noopener" class="social-share__link social-share__linkedin">
                    <span class="social-share__icon">in</span>
                    <span class="social-share__text">LinkedIn</span>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.lerian.studio%2fposts%2fconstruindo-um-financial-ledger-cqrs-eda%2f" target="_blank" rel="noopener"
                    class="social-share__link social-share__facebook">
                    <span class="social-share__icon">f</span>
                    <span class="social-share__text">Facebook</span>
                </a>
                <button class="social-share__link social-share__copy" onclick="copyToClipboard('https:\/\/blog.lerian.studio\/posts\/construindo-um-financial-ledger-cqrs-eda\/')">
                    <span class="social-share__icon">üîó</span>
                    <span class="social-share__text">Copy Link</span>
                </button>
            </div>
        </div>

        <footer class="post__footer">
            <div class="post__navigation">
                

                
                <a href="https://blog.lerian.studio/posts/gerenciando-dados-de-clientes-com-o-plugin-crm-do-midaz/" class="post__nav post__nav--next">
                    <div class="post__nav-direction">Next ‚Üí</div>
                    <div class="post__nav-title">gerenciando dados de clientes com o plugin crm do midaz: seguran√ßa e flexibilidade em primeiro lugar</div>
                </a>
                
            </div>

            <div class="post__back">
                <a href="https://blog.lerian.studio/%20/posts/" class="btn btn--outline">
                    ‚Üê Back to Articles
                </a>
            </div>
        </footer>
    </article>

    
    
    
    <section class="related-posts">
        <h2 class="related-posts__title">Related Articles</h2>
        <div class="related-posts__grid">
            
            <article class="related-post">
                
                <div class="related-post__image">
                    <a href="https://blog.lerian.studio/posts/licoes-aprendidas-na-construcao-de-uma-sdk-financeira/">
                        <img src="https://blog.lerian.studio/images/posts/sdk-development-hero.jpg"
                            alt="Software development and API integration for financial SDK" class="related-post__img">
                    </a>
                </div>
                

                <div class="related-post__content">
                    <h3 class="related-post__title">
                        <a href="https://blog.lerian.studio/posts/licoes-aprendidas-na-construcao-de-uma-sdk-financeira/">li√ß√µes aprendidas na constru√ß√£o de uma sdk financeira: onde termina o backend e come√ßa o cliente?</a>
                    </h3>

                    <div class="related-post__meta">
                        <time datetime=" 2025-05-15">
                            May 15, 2025
                        </time>
                        
                        <span class="related-post__separator">‚Ä¢</span>
                        <span class="related-post__reading-time">19 min read</span>
                        
                    </div>
                </div>
            </article>
            
        </div>
    </section>
    
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function () {
            const button = event.target.closest('.social-share__copy');
            const originalText = button.querySelector('.social-share__text').textContent;
            button.querySelector('.social-share__text').textContent = 'Copied!';
            setTimeout(() => {
                button.querySelector('.social-share__text').textContent = originalText;
            }, 2000);
        });
    }
</script>

    </main>

    <footer class="footer">
    <div class="container">
        <div class="footer__content">
            <p class="footer__text">
                ¬© 2025 Lerian Studio Blog. All rights reserved.
            </p>

            
            <div class="footer__social">
                
                <a href="https://github.com/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    Github
                </a>
                
                <a href="https://twitter.com/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    Twitter
                </a>
                
                <a href="https://linkedin.com/in/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    LinkedIn
                </a>
                
            </div>
            
        </div>
    </div>
</footer>

<style>
    .footer {
        border-top: 1px solid var(--color-gray-200);
        margin-top: var(--spacing-2xl);
        padding: var(--spacing-xl) 0;
    }

    .footer__content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .footer__text {
        color: var(--color-gray-700);
        margin: 0;
        font-size: 0.875rem;
    }

    .footer__social {
        display: flex;
        gap: var(--spacing-md);
    }

    .footer__social-link {
        color: var(--color-gray-700);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s ease;
    }

    .footer__social-link:hover {
        color: var(--color-secondary);
    }

    @media (max-width: 768px) {
        .footer__content {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggle = document.querySelector('.nav__toggle');
        const menu = document.querySelector('.nav__menu');

        if (toggle && menu) {
            toggle.addEventListener('click', function () {
                menu.classList.toggle('nav__menu--open');
            });
        }
    });
</script>
</body>

</html>