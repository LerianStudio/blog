<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>lições aprendidas na construção de uma sdk financeira: onde termina o backend e começa o cliente? | Lerian Studio Blog</title>

<meta name="description"
    content="Thoughts, ideas, and projects from Lerian Studio">



<meta property="og:title" content="lições aprendidas na construção de uma sdk financeira: onde termina o backend e começa o cliente? | Lerian Studio Blog">
<meta property="og:description"
    content="Thoughts, ideas, and projects from Lerian Studio">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.lerian.studio/posts/licoes-aprendidas-na-construcao-de-uma-sdk-financeira/">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="lições aprendidas na construção de uma sdk financeira: onde termina o backend e começa o cliente? | Lerian Studio Blog">
<meta name="twitter:description"
    content="Thoughts, ideas, and projects from Lerian Studio">


<link rel="icon" type="image/png" href="https://blog.lerian.studio/favicon.png">


<link rel="stylesheet" href="https://blog.lerian.studio/css/main.css">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Serif:wght@400;600;700&display=swap"
    rel="stylesheet">

<link rel="canonical" href="https://blog.lerian.studio/posts/licoes-aprendidas-na-construcao-de-uma-sdk-financeira/">
    
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Serif:wght@400;500;600;700&display=swap" rel="stylesheet">


<link rel="stylesheet" href="https://blog.lerian.studio/css/main.css">


    <title>lições aprendidas na construção de uma sdk financeira: onde termina o backend e começa o cliente? | Lerian Studio Blog</title>
</head>

<body>
    <header class="header">
    <div class="header__container">
        <div class="header__logo">
            <a href="https://blog.lerian.studio/%20/" class="logo">
                <img src="https://blog.lerian.studio/images/lerian-logo.svg" alt="Lerian Studio" class="logo__image">
            </a>
        </div>

        <nav class="header__nav">
            <ul class="nav__menu">
                <li><a href="https://blog.lerian.studio/%20/" class="nav__link">Home</a></li>
                <li><a href="https://blog.lerian.studio/%20/posts/" class="nav__link">Articles</a></li>
                <li><a href="https://blog.lerian.studio/%20/about/" class="nav__link">About</a></li>
            </ul>

            <button class="nav__toggle" id="nav-toggle">
                <span class="nav__hamburger"></span>
                <span class="nav__hamburger"></span>
                <span class="nav__hamburger"></span>
            </button>
        </nav>
    </div>
</header>

    <main class="main">
        
<div class="container">
    <article class="post">
        <header class="post__header">
            <h1 class="post__title">lições aprendidas na construção de uma sdk financeira: onde termina o backend e começa o cliente?</h1>

            <div class="post__meta">
                <time datetime=" 2025-05-15" class="post__date">
                    May 15, 2025
                </time>

                

                
                <span class="post__separator">•</span>
                <span class="post__reading-time">19 min read</span>
                

                <span class="post__separator">•</span>
                <span class="post__word-count">3852 words</span>
            </div>

            
            <div class="post__tags">
                
                <a href="https://blog.lerian.studio/tags/sdk/" class="tag">sdk</a>
                
                <a href="https://blog.lerian.studio/tags/api-design/" class="tag">api-design</a>
                
                <a href="https://blog.lerian.studio/tags/fintech/" class="tag">fintech</a>
                
                <a href="https://blog.lerian.studio/tags/software-architecture/" class="tag">software-architecture</a>
                
            </div>
            

            
            <div class="post__categories">
                <span class="post__categories-label">Categories:</span>
                
                <a href="https://blog.lerian.studio/categories/development/" class="category-link">Development</a>
                
                <a href="https://blog.lerian.studio/categories/api-design/" class="category-link">API Design</a>
                
            </div>
            
        </header>

        
        <div class="post__featured-image">
            <img src="https://blog.lerian.studio/images/posts/sdk-development-hero.jpg" alt="Software development and API integration for financial SDK"
                class="post__image">
            
            <figcaption class="post__image-caption">Building financial SDKs requires careful consideration of the boundary between backend and client responsibilities</figcaption>
            
        </div>
        

        <div class="post__content">
            <p>nas últimas semanas, embarcamos em um desafio por aqui: construir a primeira SDK para o Midaz, nosso ledger para core banking (disponível open-source aqui). o que parecia ser um projeto simples &ndash; afinal, openapi documentation e uma infinidade de ferramentas para generation &ndash;, rapidamente se transformou em um rabbit hole técnico bem profundo. colocar a primeira versão em produção trouxe à tona uma discussão fundamental: qual é a fronteira entre as responsabilidades do servidor e do cliente?</p>
<h2 id="fronteiras-de-responsabilidade">fronteiras de responsabilidade</h2>
<p>quando começamos a desenvolver a SDK para o Midaz (em Go), a pergunta que constantemente nos perseguia era: até onde a API do backend deve ir e onde começa a responsabilidade de integração/implementação do cliente? ou seja, onde termina o backend e começa o colo do cliente?</p>
<p>esta pergunta aparentemente simples esconde uma complexidade enorme. tradicionalmente, muitos desenvolvedores consideram que:</p>
<ul>
<li><strong>backend</strong>: responsável pela lógica de negócio, persistência, segurança, validações</li>
<li><strong>cliente/sdk</strong>: responsável apenas por fazer requisições HTTP, serializar/deserializar dados</li>
</ul>
<p>mas será que essa divisão simplista funciona bem na prática? especialmente quando falamos de sistemas financeiros com requisitos rigorosos de consistência, performance e resiliência?</p>
<h2 id="por-que-uma-sdk-robusta-importa">por que uma sdk robusta importa?</h2>
<p>durante o desenvolvimento, percebemos que uma sdk financeira precisa ir muito além de simplesmente fazer o wrapping de endpoints REST. ela precisa ser uma camada que:</p>
<ol>
<li>protege o servidor contra inputs inválidos (validação do lado cliente)</li>
<li>torna a integração mais resiliente (retries, rate limiting, circuit breaking)</li>
<li>oferece performance mesmo em condições adversas (batching, paralelismo)</li>
<li>simplifica operações complexas (abstraindo detalhes de implementação)</li>
<li>proporciona uma experiência de desenvolvimento fluida (tipos fortemente definidos, erros descritivos)</li>
</ol>
<p>vamos explorar cada um desses aspectos detalhadamente, com exemplos práticos do que implementamos na nossa primeira sdk.</p>
<h2 id="validação-no-cliente-evitando-viagens-desnecessárias">validação no cliente: evitando viagens desnecessárias</h2>
<p>uma das primeiras decisões que tomamos foi implementar validações robustas no lado cliente. por quê? simples: por que enviar ao servidor uma requisição que sabemos que vai falhar?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// exemplo de validação de transação financeira no lado cliente</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ValidateTransactionDSL</span>(<span style="color:#a6e22e">input</span> <span style="color:#a6e22e">TransactionDSLValidator</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;transaction input cannot be nil&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// valida código do ativo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">asset</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">GetAsset</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">asset</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;asset code is required&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">assetCodePattern</span>.<span style="color:#a6e22e">MatchString</span>(<span style="color:#a6e22e">asset</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid asset code format: %s (must be 3-4 uppercase letters)&#34;</span>, <span style="color:#a6e22e">asset</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// valida valor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">GetValue</span>() <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;transaction amount must be greater than zero&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// validações adicionais de contas e consistência...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>implementamos validações para:</p>
<ul>
<li>formatos de código de ativos (USD, BRL, BTC, Gado, Caixas de Remédio, whatever)</li>
<li>montantes e escalas de transações</li>
<li>estrutura de contas e operações</li>
<li>metadados e payloads auxiliares</li>
</ul>
<p>isso traz múltiplos benefícios:</p>
<ul>
<li>feedback instantâneo para o desenvolvedor</li>
<li>redução de latência (evitando roundtrips desnecessários)</li>
<li>menor carga no servidor</li>
<li>mensagens de erro mais contextualizadas e úteis</li>
</ul>
<p>a validação no cliente não substitui a validação no servidor (que continua essencial por razões de segurança), mas cria uma experiência de desenvolvimento superior e reduz o tráfego de rede.</p>
<h2 id="resiliência-através-de-retry-inteligente">resiliência através de retry inteligente</h2>
<p>sistemas distribuídos falham. esta é uma realidade, não uma possibilidade. quando trabalhamos com operações financeiras, essas falhas são ainda mais críticas e podem ter consequências significativas.</p>
<p>por isso, implementamos mecanismos sofisticados de retry com exponential backoff:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// configuração de retry com backoff exponencial</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAuthToken</span>(<span style="color:#e6db74">&#34;your-auth-token&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithRetries</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">UseAllAPIs</span>(), <span style="color:#75715e">// by the way, isso é um caso a parte aqui: pra que expor o que não precisa ser exposto?</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>nosso sistema de retry:</p>
<ul>
<li>utiliza backoff exponencial para evitar sobrecarregar servidores em problemas</li>
<li>adiciona jitter (variação aleatória) para prevenir thundering herd</li>
<li>categoriza erros entre &ldquo;retryable&rdquo; e &ldquo;non-retryable&rdquo;</li>
<li>respeita limites de timeout especificados pelo usuário</li>
<li>permite personalização completa de estratégias</li>
</ul>
<p>este código parece simples na interface, mas por trás dele há uma implementação robusta que considera diversos cenários de falha:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// trecho da implementação de retry com backoff</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">doWithOptions</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">fn</span> <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">attempt</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">attempt</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">MaxRetries</span>; <span style="color:#a6e22e">attempt</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if context is done before executing</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;operation cancelled: %w&#34;</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Execute the function</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">fn</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Success, return immediately</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if this is the last attempt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">attempt</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">MaxRetries</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if the error is retryable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">IsRetryableError</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">options</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Calculate delay with jitter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">delay</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">calculateBackoff</span>(<span style="color:#a6e22e">attempt</span>, <span style="color:#a6e22e">options</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">delayWithJitter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">addJitter</span>(<span style="color:#a6e22e">delay</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">JitterFactor</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Wait for the calculated delay or until context is done</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">timer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTimer</span>(<span style="color:#a6e22e">delayWithJitter</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">timer</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;operation cancelled during retry: %w&#34;</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">timer</span>.<span style="color:#a6e22e">C</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Continue to next retry attempt</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;operation failed after %d retries: %w&#34;</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">MaxRetries</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Um dos aprendizados mais interessantes foi identificar quais erros deveriam ser tentados novamente e quais não. Por exemplo, erros de validação nunca devem ter retry, enquanto problemas de rede temporários são candidatos ideais. Este modelo de listing by exception é um conceito que foi estudado bastante, e foi aplicado em outras enterprise-grade APIs (exemplo interessante é a da AWS).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// definição de erros retryable padrão</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DefaultRetryableErrors</span> = []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;connection reset by peer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;connection refused&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;timeout&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;deadline exceeded&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;too many requests&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;rate limit&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;service unavailable&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// códigos HTTP que merecem retry</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DefaultRetryableHTTPCodes</span> = []<span style="color:#66d9ef">int</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusRequestTimeout</span>,      <span style="color:#75715e">// 408</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusTooManyRequests</span>,     <span style="color:#75715e">// 429</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#75715e">// 500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadGateway</span>,          <span style="color:#75715e">// 502</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusServiceUnavailable</span>,  <span style="color:#75715e">// 503</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusGatewayTimeout</span>,      <span style="color:#75715e">// 504</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="gerenciamento-avançado-de-configurações">gerenciamento avançado de configurações</h2>
<p>a modularidade da configuração foi um ponto crítico do design. utilizamos o padrão de opções funcionais (não são 100% fluentes como pede o figurin) para permitir uma configuração limpa e extensível:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// padrão de options funcionais para configuração flexível</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// configurações básicas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAuthToken</span>(<span style="color:#e6db74">&#34;your-auth-token&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithEnvironment</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">EnvironmentProduction</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// opções avançadas de performance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithRetries</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">200</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// observabilidade</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithObservability</span>(<span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// quais APIs utilizar</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">UseAllAPIs</span>(),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>este padrão permite:</p>
<ul>
<li>configuração incremental com defaults sensatos</li>
<li>melhor legibilidade e manutenção</li>
<li>extensibilidade futura sem quebrar compatibilidade</li>
<li>configurações específicas por domínio</li>
</ul>
<p>Além disso, implementamos suporte para configuração via variáveis de ambiente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// variáveis de ambiente que o cliente reconhece</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_AUTH_TOKEN</span>=<span style="color:#a6e22e">seu</span><span style="color:#f92672">-</span><span style="color:#a6e22e">token</span> <span style="color:#75715e">// implementaremos a sdk de access management lançada ontem logo logo</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_ENVIRONMENT</span>=<span style="color:#a6e22e">production</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_ONBOARDING_URL</span>=<span style="color:#a6e22e">https</span>:<span style="color:#75715e">//api.exemplo.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_TRANSACTION_URL</span>=<span style="color:#a6e22e">https</span>:<span style="color:#75715e">//transactions.exemplo.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_DEBUG</span>=<span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MIDAZ_MAX_RETRIES</span>=<span style="color:#ae81ff">5</span>
</span></span></code></pre></div><p>isso permite uma integração mais suave com diferentes ambientes de deploy, especialmente em contextos de containers e kubernetes.</p>
<h2 id="performance-otimizada-para-json">performance otimizada para JSON</h2>
<p>Em sistemas financeiros, performance não é luxo, é requisito. Um dos pontos de maior otimização foi o processamento JSON, que pode rapidamente se tornar um gargalo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// exemplo de nossa implementação de pooling de buffers para JSON</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JSONPerformance</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">encoderPool</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">decoderPool</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bufferPool</span>  <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewJSONPerformance</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">JSONPerformance</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">JSONPerformance</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">encoderPool</span>: <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Discard</span>)
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">decoderPool</span>: <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bufferPool</span>: <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> new(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">jp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">JSONPerformance</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jp</span>.<span style="color:#a6e22e">bufferPool</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Reset</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">jp</span>.<span style="color:#a6e22e">bufferPool</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jp</span>.<span style="color:#a6e22e">encoderPool</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Encoder</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">SetEscapeHTML</span>(<span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">oldWriter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">Linter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">SetWriter</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">SetWriter</span>(<span style="color:#a6e22e">oldWriter</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">jp</span>.<span style="color:#a6e22e">encoderPool</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">enc</span>)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">v</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Copy to avoid returning a reference to the pooled buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Len</span>())
</span></span><span style="display:flex;"><span>    copy(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Bytes</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Esta abordagem reduziu alocações de memória em nossos benchmarks, principalmente quando fazíamos em conjunto com o pooling de buffers, o que é crucial para sistemas financeiros de alto volume que processam milhões de transações.</p>
<h2 id="páginação-inteligente-e-universal">páginação inteligente e universal</h2>
<p>Lidar com grandes conjuntos de dados é um desafio comum em operações financeiras. Por isso, desenvolvemos um sistema de paginação universal que funciona com diferentes endpoints e paradigmas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// interface genérica para qualquer tipo de paginador</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Paginator</span>[<span style="color:#a6e22e">T</span> <span style="color:#66d9ef">any</span>] <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HasNext</span>() <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Next</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">ListResponse</span>[<span style="color:#a6e22e">T</span>], <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Reset</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// exemplo de uso para listar transações com paginação automática</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">paginator</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">GetTransactionPaginator</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;org-id&#34;</span>, <span style="color:#e6db74">&#34;ledger-id&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">Limit</span>: <span style="color:#ae81ff">100</span>},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">totalTransactions</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">paginator</span>.<span style="color:#a6e22e">HasNext</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">paginator</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tx</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">Items</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// processar cada transação</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">processTransaction</span>(<span style="color:#a6e22e">tx</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">totalTransactions</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Processadas %d transações no total\n&#34;</span>, <span style="color:#a6e22e">totalTransactions</span>)
</span></span></code></pre></div><p>Nossa implementação suporta:</p>
<ul>
<li>páginação por offset/limit (mais comum)</li>
<li>páginação por cursor (mais eficiente para grandes datasets)</li>
<li>prefetching para melhor performance</li>
<li>preservação de filtros e ordenação entre páginas</li>
<li>adaptação automática ao tipo de paginação do endpoint</li>
<li>concorrência controlada para alto volume</li>
</ul>
<p>Para lidar com os requisitos de alta performance, investimos pesadamente em modelos de concorrência bem controlados:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// worker pool genérico com controle fino de concorrência</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WorkerPool</span>[<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">R</span> <span style="color:#66d9ef">any</span>](
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">items</span> []<span style="color:#a6e22e">T</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">workFn</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">T</span>) (<span style="color:#a6e22e">R</span>, <span style="color:#66d9ef">error</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">PoolOption</span>,
</span></span><span style="display:flex;"><span>) []<span style="color:#a6e22e">Result</span>[<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">R</span>] {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Config default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">defaultPoolOptions</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">opts</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">opt</span>(<span style="color:#a6e22e">options</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resultCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">Result</span>[<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">R</span>], len(<span style="color:#a6e22e">items</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// semáforo para controlar concorrência</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sem</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">workers</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Rate limiter se especificado</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">limiter</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">rateLimit</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">rateLimit</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">limiter</span> = <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">items</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Respeita cancelamento pelo context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Rate limiting se ativo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">limiter</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">limiter</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Continue quando o rate limiter permitir</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Adquire slot no semáforo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sem</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">idx</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">item</span> <span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() { <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sem</span> }() <span style="color:#75715e">// Libera o semáforo ao final</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Cria um timeout interno se necessário</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">execCtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">timeout</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cancel</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">CancelFunc</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">execCtx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">timeout</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Executa a função de trabalho</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">workFn</span>(<span style="color:#a6e22e">execCtx</span>, <span style="color:#a6e22e">item</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Envia o resultado</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">resultCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">Result</span>[<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">R</span>]{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Index</span>: <span style="color:#a6e22e">idx</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Item</span>:  <span style="color:#a6e22e">item</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">result</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Error</span>: <span style="color:#a6e22e">err</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">item</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Fecha o canal de resultados quando todo trabalho estiver concluído</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>        close(<span style="color:#a6e22e">resultCh</span>)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Coleta resultados</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">results</span> []<span style="color:#a6e22e">Result</span>[<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">R</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">resultCh</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">results</span> = append(<span style="color:#a6e22e">results</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ordena resultados se necessário</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">ordered</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Slice</span>(<span style="color:#a6e22e">results</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">results</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Index</span> &lt; <span style="color:#a6e22e">results</span>[<span style="color:#a6e22e">j</span>].<span style="color:#a6e22e">Index</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">results</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Esta implementação permite:</p>
<ul>
<li>Controle preciso de concorrência para evitar sobrecarregar a API</li>
<li>Rate limiting para respeitar limites da API</li>
<li>Ordenação opcional de resultados</li>
<li>Cancelamento gracioso de operações em andamento</li>
<li>Timeouts individuais para tarefas</li>
</ul>
<h2 id="tratamento-avançado-de-erros-financeiros">tratamento avançado de erros financeiros</h2>
<p>Em um sistema financeiro, os erros são parte crítica da experiência do desenvolvedor. Investimos em um sistema sofisticado de tratamento de erros:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// exemplo de uso de erros especializados</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsValidationError</span>(<span style="color:#a6e22e">err</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Trata erro de validação</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Erro de validação:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Extrai erros por campo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fieldErrors</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">GetFieldErrors</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">fieldErr</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fieldErrors</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Campo %s: %s\n&#34;</span>, <span style="color:#a6e22e">fieldErr</span>.<span style="color:#a6e22e">Field</span>, <span style="color:#a6e22e">fieldErr</span>.<span style="color:#a6e22e">Message</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsInsufficientBalanceError</span>(<span style="color:#a6e22e">err</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Trata erro específico financeiro</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Saldo insuficiente:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsRateLimitExceededError</span>(<span style="color:#a6e22e">err</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Implementa backoff e retry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Limite de requisições excedido, aguardando:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">exponentialBackoff</span>(<span style="color:#a6e22e">attempt</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsAuthenticationError</span>(<span style="color:#a6e22e">err</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Problema com autenticação</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Erro de autenticação, renovando token:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">renewToken</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Adicionalmente, nossos erros incluem:</p>
<ul>
<li>Categorização clara (validação, autenticação, rede, etc)</li>
<li>Detalhes específicos por domínio financeiro (saldo insuficiente, limites, etc)</li>
<li>Códigos de erro e status HTTP associados</li>
<li>Sugestões de correção para o desenvolvedor</li>
<li>Integração com observabilidade (geração de span de erro)</li>
<li>Testes de stress e verificação de escalabilidade</li>
</ul>
<p>Uma característica distintiva da nossa SDK foi o desenvolvimento de uma suite robusta de testes de stress:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// trecho do código da suite de stress testing</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">st</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StressTest</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">observability</span>.<span style="color:#a6e22e">GetLogger</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Iniciando teste de stress&#34;</span>, <span style="color:#e6db74">&#34;workers&#34;</span>, <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ConcurrentWorkers</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Preparar ambiente de teste</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">SetupTestEnvironment</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;falha ao configurar ambiente: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Executar até interrupção ou duração configurada</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Inicia monitoramento de métricas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">metrics</span> = <span style="color:#a6e22e">NewMetricsCollector</span>(<span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">observability</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Inicia workers para gerar carga</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ConcurrentWorkers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">workerID</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">runWorker</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">workerID</span>)
</span></span><span style="display:flex;"><span>        }(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Aguarda conclusão</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Teste de stress concluído&#34;</span>, <span style="color:#e6db74">&#34;transações&#34;</span>, <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">TotalTransactions</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Esta suite nos permitiu:</p>
<ul>
<li>Validar o comportamento sob carga extrema (50.000+ tx/s ou modelos de 1:1 em conta com 10000+ tx/s)</li>
<li>Identificar e corrigir bottlenecks antes do lançamento</li>
<li>Verificar o comportamento de mecanismos de retry e resiliência</li>
<li>Testar a degradação graceful sob falhas parciais</li>
<li>Validar limites de recursos (memória, CPU, conexões, e o próprio sistema distribuído)</li>
</ul>
<p>No ponto específico de validar limites de recursos e do sistema distribuído, utilizamos o pumba para simular cenários de caos (em docker), e isso nos ajudou a identificar pontos interessantes na implementação do próprio backend.</p>
<h2 id="documentação-direcionada-por-exemplos">documentação direcionada por exemplos</h2>
<p>Percebemos que bons exemplos são mais valiosos que documentação abstrata. Por isso, demos ênfase especial a exemplos práticos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// exemplo completo de transferência entre contas</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ExampleTransferBetweenAccounts</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Inicializar cliente</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAuthToken</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;MIDAZ_TOKEN&#34;</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">UseAllAPIs</span>(),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Erro inicializando cliente: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Definir detalhes da transação</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">TransactionDSLInput</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Description</span>: <span style="color:#e6db74">&#34;Transferência para pagamento de aluguel&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Send</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLSend</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Asset</span>: <span style="color:#e6db74">&#34;BRL&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Value</span>: <span style="color:#ae81ff">150000</span>, <span style="color:#75715e">// R$ 1.500,00</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Scale</span>: <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Source</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLSource</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">From</span>: []<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLFromTo</span>{
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">Account</span>: <span style="color:#e6db74">&#34;conta-origem-123&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">Amount</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLAmount</span>{
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Asset</span>: <span style="color:#e6db74">&#34;BRL&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Value</span>: <span style="color:#ae81ff">150000</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Scale</span>: <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Distribute</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLDistribute</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">To</span>: []<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLFromTo</span>{
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">Account</span>: <span style="color:#e6db74">&#34;conta-destino-456&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">Amount</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">DSLAmount</span>{
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Asset</span>: <span style="color:#e6db74">&#34;BRL&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Value</span>: <span style="color:#ae81ff">150000</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">Scale</span>: <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Metadata</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">any</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;referencia&#34;</span>: <span style="color:#e6db74">&#34;aluguel-julho-2025&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;categoria&#34;</span>: <span style="color:#e6db74">&#34;moradia&#34;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Executar a transação</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">CreateTransactionWithDSL</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;org-exemplo&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ledger-principal&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">input</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Erro na transferência: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Transferência realizada com sucesso! ID: %s\n&#34;</span>, <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">ID</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Cada exemplo está acompanhado de comentários detalhados e cobrimos todos os cenários principais:</p>
<ul>
<li>Criação de entidades (organizações, contas, etc)</li>
<li>Operações financeiras (transferências, depósitos, saques)</li>
<li>Consultas e relatórios (balanços, extratos, histórico)</li>
<li>Workflows completos (onboarding, transações)</li>
</ul>
<p>A vantagem da unificação de interface
Falando um pouco sobre a vantagem de unificar múltiplas APIs de backend sob uma interface coerente: no mundo financeiro, frequentemente temos APIs separadas para diferentes domínios:</p>
<ul>
<li>API de onboarding (organizações, contas)</li>
<li>API de transactions (transferências, saldos)</li>
<li>API de compliance (KYC, AML)</li>
<li>API de reporting (relatórios, extratos)</li>
<li>etc etc etc</li>
</ul>
<p>Cada uma com suas peculiaridades e convenções. Nossa SDK unifica todas sob uma única interface consistente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Mesmo padrão para todas as APIs, independente do backend</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// API de onboarding</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">organization</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Organizations</span>.<span style="color:#a6e22e">CreateOrganization</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// API de transactions</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">transaction</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">CreateTransaction</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">orgID</span>, <span style="color:#a6e22e">ledgerID</span>, <span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// API de balanços</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">balance</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Accounts</span>.<span style="color:#a6e22e">GetBalance</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">orgID</span>, <span style="color:#a6e22e">ledgerID</span>, <span style="color:#a6e22e">accountID</span>)
</span></span></code></pre></div><p>Esta unificação traz benefícios significativos para o desenvolvedor em si:</p>
<ul>
<li>Reduz a curva de aprendizado para novos desenvolvedores</li>
<li>Abstrai as diferenças de implementação entre serviços</li>
<li>Permite evolução independente do backend e frontend</li>
<li>Facilita migração entre diferentes versões de APIs</li>
</ul>
<p>A discussão sobre fronteiras: o que aprendemos
Voltando à questão inicial sobre as fronteiras de responsabilidade entre servidor e cliente, concluímos que a resposta não é binária. Em vez disso, é um espectro que depende do contexto:</p>
<ul>
<li>Validação: tanto cliente quanto servidor devem validar - cliente para UX e DevEx, servidor para segurança</li>
<li>Resiliência: principalmente responsabilidade do cliente, com suporte do servidor (idempotência, o que nossa API também trata com uma option específica de WithIdempotency())</li>
<li>Performance: responsabilidade compartilhada, com otimizações específicas em cada lado</li>
<li>Domínio: o servidor define o modelo, mas o cliente pode enriquecê-lo com abstrações úteis</li>
</ul>
<p>O que ficou claro é que SDKs não são meros wrappers de API - elas são produtos completos que precisam considerar toda a experiência do desenvolvedor e os requisitos específicos do domínio.</p>
<h2 id="trade-offs-e-desafios-de-design-importantes">trade-offs e desafios de design importantes</h2>
<p>Durante o desenvolvimento da SDK, nos confrontamos com vários trade-offs importantes que impactam diretamente desenvolvedores e usuários:</p>
<ul>
<li>Validação no cliente vs. sincronização com o servidor</li>
<li>A implementação de validações robustas no cliente traz benefícios claros de performance e experiência do desenvolvedor, mas também introduz um desafio:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Se estas regras de validação mudam no servidor...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">assetCodePattern</span>.<span style="color:#a6e22e">MatchString</span>(<span style="color:#a6e22e">asset</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid asset code format: %s (must be 3-4 uppercase letters)&#34;</span>, <span style="color:#a6e22e">asset</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Este é um trade-off significativo:</p>
<ul>
<li>Vantagem: redução de latência e feedback instantâneo</li>
<li>Desvantagem: potencial divergência entre regras cliente/servidor se os clientes não atualizarem a SDK</li>
</ul>
<p>Nossa solução foi documentar claramente a necessidade de atualizações regulares e fornecer testes que ajudam a detectar divergências de validação, além de fazer um robusto linking entre models do cliente e do servidor.</p>
<ul>
<li>Filosofia de tratamento de erros: o que tratar automaticamente?</li>
<li>Uma decisão crítica foi determinar quais erros a SDK deveria tratar automaticamente versus quais deveriam ser expostos para o backend:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Erros tratados automaticamente pela SDK</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsTemporaryNetworkError</span>(<span style="color:#a6e22e">err</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsRateLimitExceeded</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Aplicar retry automaticamente</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">retry</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">operation</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Erros que são propagados ao aplicativo</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsBusinessRuleViolation</span>(<span style="color:#a6e22e">err</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsValidationError</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// O desenvolvedor precisa tratar estes casos explicitamente</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Adotamos a filosofia de que:</p>
<ul>
<li>
<p>Erros transientes de infraestrutura/rede são tratados pela SDK</p>
</li>
<li>
<p>Erros de domínio financeiro ou validação são propagados para permitir tratamento adequado pelo backend</p>
</li>
<li>
<p>Erros críticos (autenticação, permissões) são propagados com contexto enriquecido para facilitar diagnóstico</p>
</li>
<li>
<p>Integração de observabilidade: o equilíbrio entre intrusão e visibilidade</p>
</li>
<li>
<p>A observabilidade é crítica em sistemas financeiros, mas quanto a SDK deve impor versus oferecer como opcional? Aqui é um caso a parte. Remodelamos toda a stack de observabilidade (usando opentelemetry) para que o desenvolvedor possa escolher o que ele quer e o que ele não quer, sem sermos &ldquo;opinionated&rdquo; com relação ao tema &ndash; bem diferente do contexto do midaz open-source, que é mais &ldquo;opinionated&rdquo;.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Abordagem não-intrusiva que adotamos:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Configuração básica</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAuthToken</span>(<span style="color:#e6db74">&#34;token&#34;</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Observabilidade totalmente opcional</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithObservability</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">observability</span>.<span style="color:#a6e22e">WithTracing</span>(<span style="color:#a6e22e">userDefinedTraceProvider</span>),  <span style="color:#75715e">// opcional</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">observability</span>.<span style="color:#a6e22e">WithMetrics</span>(<span style="color:#a6e22e">userDefinedMeterProvider</span>),  <span style="color:#75715e">// opcional</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">observability</span>.<span style="color:#a6e22e">WithLogging</span>(<span style="color:#a6e22e">userDefinedLogger</span>),         <span style="color:#75715e">// opcional</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Decidimos por uma abordagem modular onde:</p>
<ul>
<li>
<p>A SDK funciona perfeitamente sem observabilidade configurada</p>
</li>
<li>
<p>Desenvolvedores podem injetar seus próprios providers de observabilidade</p>
</li>
<li>
<p>Fornecemos implementações default para casos simples</p>
</li>
<li>
<p>Instrumentamos pontos críticos nas operações financeiras para máxima visibilidade</p>
</li>
<li>
<p>Operações Assíncronas e Notificações</p>
</li>
<li>
<p>Transações financeiras frequentemente envolvem processos assíncronos. Como a SDK deve lidar com isso?</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Opção 1: Polling (implementamos inicialmente)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">GetTransactionStatus</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">txID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Opção 2: Webhooks (planejado para futuro)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">RegisterWebhookHandler</span>(<span style="color:#a6e22e">webhookHandler</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Opção 3: Response streaming (planejado para futuro)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">WatchTransaction</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">txID</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">Updates</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Processar atualizações em tempo real</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nossa abordagem foi evolutiva. Tomamos uma decisão de implementar o básico agora, mas permitindo uma modelagem como a acima exposta:</p>
<p>Começamos com polling simples para compatibilidade ampla
Adicionaremos suporte a webhooks para notificações em tempo real
E planejamos, por fim, streaming de atualizações para casos de uso mais complexos</p>
<h2 id="estratégia-de-versionamento-e-compatibilidade-planejado-para-em-breve-dado-que-estamos-na-v1-do-midaz">estratégia de versionamento e compatibilidade planejado para em breve, dado que estamos na V1 do Midaz</h2>
<p>O versionamento é um desafio significativo em APIs financeiras que evoluem constantemente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Suporte a múltiplas versões de API</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAPIVersion</span>(<span style="color:#e6db74">&#34;v1&#34;</span>),  <span style="color:#75715e">// default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ou</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAPIVersion</span>(<span style="color:#e6db74">&#34;v2&#34;</span>),  <span style="color:#75715e">// novas funcionalidades</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Usando feature flags para recursos em preview</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">CreateTransaction</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">orgID</span>, <span style="color:#a6e22e">ledgerID</span>, <span style="color:#a6e22e">input</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transactions</span>.<span style="color:#a6e22e">WithFeatureEnabled</span>(<span style="color:#e6db74">&#34;instant-settlement&#34;</span>),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Adotaremos uma estratégia de versionamento com múltiplas camadas:</p>
<ul>
<li>Versionamento semântico tradicional para a SDK</li>
<li>Compatibilidade com múltiplas versões de API em uma única versão da SDK</li>
<li>Feature flags para recursos experimentais</li>
<li>Aliases de métodos deprecados com warnings para facilitar migrações</li>
</ul>
<h2 id="aprendizados-para-o-futuro">aprendizados para o futuro</h2>
<p>Lançar a primeira versão de uma SDK não é o fim da jornada, mas apenas o começo. Já identificamos diversas áreas para evolução:</p>
<ul>
<li>Estratégia evolutiva: como evoluir a API sem quebrar compatibilidade? como evoluir o backend sem quebrar compatibilidade? como fazer tudo isso e mantermos o decoupling super necessário entre midaz e midaz-sdk-golang versioning</li>
<li>Abstrações de domínio: quais abstrações de nível superior devemos oferecer para simplificar fluxos comuns? que tal evoluirmos para DoWithdrawal, DoDeposit, DoTransfer, etc, fazendo a abstração entre a conta @external/asset e o domínio de transações. que tal evoluirmos para sdk apis 100% fluentes?</li>
<li>Balanceamento de responsabilidades: conforme o produto evolui, qual o equilíbrio ideal entre lógica no servidor e no cliente? afinal, não queremos obrigar nossos clientes a usarem a sdk, até pq não conseguiremos manter sdks em um número grande de linguagens</li>
<li>Extensibilidade: como permitir que usuários estendam a SDK para seus casos específicos? o fato de sermos open-source facilita isso e chama o público para nos ajudar, mas sabemos da nossa responsabilidade como principais mantenedores do midaz e sua stack</li>
</ul>
<p>Particularmente interessante é a questão dos modelos de domínio. Por exemplo, em vez de apenas oferecer a API para criar uma transação, devemos evoluir para oferecer construções de mais alto nível:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Potencial evolução futura - Abstrações de domínio mais ricas</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Em vez de apenas criar transações</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">CreateTransaction</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">orgID</span>, <span style="color:#a6e22e">ledgerID</span>, <span style="color:#a6e22e">createTxInput</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Oferecer fluxos de domínio completos</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">transferResult</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Workflows</span>.<span style="color:#a6e22e">DoTransfer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">transferOptions</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">paymentResult</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Workflows</span>.<span style="color:#a6e22e">DoPayment</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">paymentOptions</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fxResult</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Workflows</span>.<span style="color:#a6e22e">DoForeignExchangeTransfer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">fxOptions</span>)
</span></span></code></pre></div><h2 id="o-padrão-functional-options-flexibilidade-sem-complexidade">o padrão functional options: flexibilidade sem complexidade</h2>
<p>um padrão de design que merece destaque especial na nossa sdk é o uso extensivo de functional options (ou a implementação parcial de fluent apis). este padrão permite configuração flexível sem comprometer a legibilidade ou simplicidade:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// definição básica do padrão</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ClientOption</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#a6e22e">ClientOption</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">timeout</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;timeout must be positive&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">httpClient</span>.<span style="color:#a6e22e">Timeout</span> = <span style="color:#a6e22e">timeout</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// uso elegante e extensível</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithAuthToken</span>(<span style="color:#e6db74">&#34;seu-token&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithRetries</span>(<span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">WithObservability</span>(<span style="color:#66d9ef">true</span>),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>este padrão oferece múltiplas vantagens:</p>
<ul>
<li>evita a explosão de construtores para diferentes combinações de opções</li>
<li>permite adicionar novos parâmetros sem quebrar código existente</li>
<li>facilita testes e configurações condicionais</li>
<li>proporciona validação no momento da configuração</li>
<li>permite opções compostas que aplicam múltiplas configurações</li>
</ul>
<p>aplicamos o mesmo padrão em diversos níveis da sdk, não apenas na inicialização do cliente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// nível de operação - opções específicas por operação</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Transactions</span>.<span style="color:#a6e22e">CreateTransaction</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">orgID</span>, <span style="color:#a6e22e">ledgerID</span>, <span style="color:#a6e22e">input</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transactions</span>.<span style="color:#a6e22e">WithIdempotencyKey</span>(<span style="color:#e6db74">&#34;unique-key-123&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transactions</span>.<span style="color:#a6e22e">WithPriority</span>(<span style="color:#a6e22e">transactions</span>.<span style="color:#a6e22e">PriorityHigh</span>),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// nível de entidade - configurações por domínio</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">accountSvc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entity</span>.<span style="color:#a6e22e">Accounts</span>.<span style="color:#a6e22e">WithOptions</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">accounts</span>.<span style="color:#a6e22e">WithCaching</span>(<span style="color:#66d9ef">true</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">accounts</span>.<span style="color:#a6e22e">WithValidation</span>(<span style="color:#a6e22e">accounts</span>.<span style="color:#a6e22e">ValidationStrict</span>),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="conclusão">conclusão</h2>
<p>construir a sdk do midaz foi uma jornada de aprendizado e de um estado de flow absurdo. as complexidades de sistemas distribuídos, especialmente no domínio financeiro, e as decisões que tomamos - desde validação robusta no cliente até mecanismos avançados de resiliência e performance - foram todas guiadas pela pergunta: &ldquo;o que tornaria a vida do desenvolvedor mais fácil e o sistema mais confiável?&rdquo;</p>
<p>no final, a fronteira entre cliente e servidor é mais sobre colaboração do que separação. uma boa sdk não apenas encapsula uma api, mas amplia suas capacidades e protege contra suas limitações.</p>
<p>a gestão cuidadosa dos trade-offs que destacamos - validação no cliente versus sincronização com o servidor, tratamento automático versus exposição de erros, modularidade de observabilidade, e estratégias para operações assíncronas - moldou uma sdk que equilibra simplicidade e poder.</p>
<p>se você estiver construindo uma sdk, especialmente para sistemas críticos como o financeiro, sugiro considerar cuidadosamente onde colocar essas fronteiras de responsabilidade. sua resposta pode não ser a mesma que a nossa, mas fazer a pergunta já é um excelente começo.</p>
<p>bora?</p>
<p>para quem quiser explorar mais, a midaz sdk está disponível em nosso github e inclui extensos exemplos de uso. os exemplos de código e implementações de referência fornecem insights valiosos sobre como implementar padrões robustos em sdks financeiras.</p>
<p>o que você acha? onde você traçaria a linha entre responsabilidades de cliente e servidor em uma sdk? aproveita e dá uma estrelinha pra gente! o midaz está aqui, nosso frontend console está aqui, e nossa sdk está aqui.</p>
<p>next steps?
port para js. quite a challenge!</p>
<p>beijos,
fred.</p>

        </div>

        
        <div class="post__sharing">
            <h3 class="post__sharing-title">Share this article</h3>
            <div class="social-share">
                <a href="https://twitter.com/intent/tweet?text=li%C3%A7%C3%B5es&#43;aprendidas&#43;na&#43;constru%C3%A7%C3%A3o&#43;de&#43;uma&#43;sdk&#43;financeira%3A&#43;onde&#43;termina&#43;o&#43;backend&#43;e&#43;come%C3%A7a&#43;o&#43;cliente%3F&url=https%3a%2f%2fblog.lerian.studio%2fposts%2flicoes-aprendidas-na-construcao-de-uma-sdk-financeira%2f"
                    target="_blank" rel="noopener" class="social-share__link social-share__twitter">
                    <span class="social-share__icon">𝕏</span>
                    <span class="social-share__text">Twitter</span>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fblog.lerian.studio%2fposts%2flicoes-aprendidas-na-construcao-de-uma-sdk-financeira%2f" target="_blank"
                    rel="noopener" class="social-share__link social-share__linkedin">
                    <span class="social-share__icon">in</span>
                    <span class="social-share__text">LinkedIn</span>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.lerian.studio%2fposts%2flicoes-aprendidas-na-construcao-de-uma-sdk-financeira%2f" target="_blank" rel="noopener"
                    class="social-share__link social-share__facebook">
                    <span class="social-share__icon">f</span>
                    <span class="social-share__text">Facebook</span>
                </a>
                <button class="social-share__link social-share__copy" onclick="copyToClipboard('https:\/\/blog.lerian.studio\/posts\/licoes-aprendidas-na-construcao-de-uma-sdk-financeira\/')">
                    <span class="social-share__icon">🔗</span>
                    <span class="social-share__text">Copy Link</span>
                </button>
            </div>
        </div>

        <footer class="post__footer">
            <div class="post__navigation">
                
                <a href="https://blog.lerian.studio/posts/gerenciando-dados-de-clientes-com-o-plugin-crm-do-midaz/" class="post__nav post__nav--prev">
                    <div class="post__nav-direction">← Previous</div>
                    <div class="post__nav-title">gerenciando dados de clientes com o plugin crm do midaz: segurança e flexibilidade em primeiro lugar</div>
                </a>
                

                
                <a href="https://blog.lerian.studio/posts/hello-world/" class="post__nav post__nav--next">
                    <div class="post__nav-direction">Next →</div>
                    <div class="post__nav-title">Hello, World!</div>
                </a>
                
            </div>

            <div class="post__back">
                <a href="https://blog.lerian.studio/posts/" class="btn btn--outline">
                    ← Back to Articles
                </a>
            </div>
        </footer>
    </article>

    
    
    
    <section class="related-posts">
        <h2 class="related-posts__title">Related Articles</h2>
        <div class="related-posts__grid">
            
            <article class="related-post">
                
                <div class="related-post__image">
                    <a href="https://blog.lerian.studio/posts/construindo-um-financial-ledger-cqrs-eda/">
                        <img src="https://blog.lerian.studio/images/posts/financial-ledger-hero.jpg"
                            alt="Financial technology and data visualization representing CQRS and EDA architecture" class="related-post__img">
                    </a>
                </div>
                

                <div class="related-post__content">
                    <h3 class="related-post__title">
                        <a href="https://blog.lerian.studio/posts/construindo-um-financial-ledger-cqrs-eda/">construindo um financial ledger com cqrs e eda</a>
                    </h3>

                    <div class="related-post__meta">
                        <time datetime=" 2025-05-15">
                            May 15, 2025
                        </time>
                        
                        <span class="related-post__separator">•</span>
                        <span class="related-post__reading-time">11 min read</span>
                        
                    </div>
                </div>
            </article>
            
        </div>
    </section>
    
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function () {
            const button = event.target.closest('.social-share__copy');
            const originalText = button.querySelector('.social-share__text').textContent;
            button.querySelector('.social-share__text').textContent = 'Copied!';
            setTimeout(() => {
                button.querySelector('.social-share__text').textContent = originalText;
            }, 2000);
        });
    }
</script>

    </main>

    <footer class="footer">
    <div class="container">
        <div class="footer__content">
            <p class="footer__text">
                © 2025 Lerian Studio Blog. All rights reserved.
            </p>

            
            <div class="footer__social">
                
                <a href="https://github.com/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    Github
                </a>
                
                <a href="https://twitter.com/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    Twitter
                </a>
                
                <a href="https://linkedin.com/in/lerianstudio" class="footer__social-link" target="_blank" rel="noopener noreferrer">
                    LinkedIn
                </a>
                
            </div>
            
        </div>
    </div>
</footer>

<style>
    .footer {
        border-top: 1px solid var(--color-gray-200);
        margin-top: var(--spacing-2xl);
        padding: var(--spacing-xl) 0;
    }

    .footer__content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .footer__text {
        color: var(--color-gray-700);
        margin: 0;
        font-size: 0.875rem;
    }

    .footer__social {
        display: flex;
        gap: var(--spacing-md);
    }

    .footer__social-link {
        color: var(--color-gray-700);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s ease;
    }

    .footer__social-link:hover {
        color: var(--color-secondary);
    }

    @media (max-width: 768px) {
        .footer__content {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggle = document.querySelector('.nav__toggle');
        const menu = document.querySelector('.nav__menu');

        if (toggle && menu) {
            toggle.addEventListener('click', function () {
                menu.classList.toggle('nav__menu--open');
            });
        }
    });
</script>
</body>

</html>